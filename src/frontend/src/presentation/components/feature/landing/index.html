<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GreenWave: Clean Air Interactive Demo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      /* Custom styles for the full screen canvas and body */
      body,
      html {
        margin: 0;
        padding: 0;
        overflow: hidden;
        height: 100%;
        background-color: #ffffff;
      }
      #cleanCanvas {
        display: block;
        width: 100%;
        height: 100%;
        touch-action: none; /* Prevents default touch behavior */
      }
      .main-container {
        position: relative;
        width: 100vw;
        height: 100vh;
      }
    </style>
  </head>
  <body>
    <div class="main-container">
      <canvas id="cleanCanvas"></canvas>

      <!-- Interactive Overlay Button -->
      <div
        id="controlPanel"
        class="absolute inset-0 flex flex-col items-center justify-center p-8 pointer-events-none"
      >
        <button
          id="cleanButton"
          class="bg-[#4caf50] text-white font-bold py-4 px-8 rounded-full shadow-lg transition duration-300 ease-in-out hover:bg-green-600 hover:shadow-2xl active:scale-95 transform pointer-events-auto text-xl sm:text-2xl md:text-3xl border-4 border-white animate-pulse"
        >
          KÍCH HOẠT LÀN SÓNG XANH!
        </button>
        <p
          id="message"
          class="mt-4 text-sm sm:text-base font-semibold text-gray-700 bg-white/70 backdrop-blur-sm px-4 py-2 rounded-lg shadow-md transition-opacity duration-500 opacity-0"
        >
          Nhấn vào nút để dọn sạch ô nhiễm!
        </p>
      </div>
    </div>

    <script>
      // --- Firebase Setup (Required to be present but not used for this visual demo) ---
      // These variables are provided by the canvas environment.
      const appId =
        typeof __app_id !== "undefined" ? __app_id : "default-app-id";
      // const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
      // const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
      // ---------------------------------------------------------------------------------

      const canvas = document.getElementById("cleanCanvas");
      const ctx = canvas.getContext("2d");
      const cleanButton = document.getElementById("cleanButton");
      const messageElement = document.getElementById("message");

      // Color definitions
      const GREEN_PRIMARY = "#4caf50"; // Main green
      const GREEN_LIGHT = "#e8f5e9"; // Light green accent
      const POLLUTION_GRAY = "#757575"; // Pollution color
      const TRAFFIC_DARK = "#424242"; // Traffic/car color
      const CLEAN_AIR_LIGHT = "#C8E6C9"; // Very light green/clean air

      let particles = [];
      let cars = [];
      let isWaving = false;
      let waveProgress = 0;

      const MAX_PARTICLES = 300;
      const MAX_CARS = 20;

      /**
       * Represents a single particle of smog/pollution.
       */
      class Particle {
        constructor() {
          this.reset();
        }

        reset() {
          this.x = Math.random() * canvas.width;
          this.y = Math.random() * canvas.height;
          this.size = Math.random() * 3 + 1;
          this.speedX = Math.random() * 0.5 - 0.25; // Slow horizontal drift
          this.speedY = Math.random() * 0.5; // Slow upward movement
          this.color = POLLUTION_GRAY;
          this.opacity = 0.5 + Math.random() * 0.5;
          this.isClean = false;
        }

        update() {
          this.x += this.speedX;
          this.y -= this.speedY;

          // Loop particle from bottom to top
          if (this.y < -this.size) {
            this.y = canvas.height + this.size;
            this.x = Math.random() * canvas.width;
            // Keep existing clean state if applicable
          }

          // Keep particle on screen horizontally
          if (this.x < -this.size || this.x > canvas.width + this.size) {
            this.x = this.x < 0 ? canvas.width + this.size : -this.size;
          }

          if (this.isClean) {
            // Clean particles move faster and fade out
            this.speedY += 0.05;
            this.opacity -= 0.01;
            if (this.opacity <= 0) this.reset();
          }
        }

        draw() {
          ctx.beginPath();
          ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
          ctx.fillStyle = this.isClean
            ? CLEAN_AIR_LIGHT
            : `rgba(${parseInt(this.color.slice(1, 3), 16)}, ${parseInt(
                this.color.slice(3, 5),
                16
              )}, ${parseInt(this.color.slice(5, 7), 16)}, ${this.opacity})`;
          ctx.fill();
        }
      }

      /**
       * Represents a small traffic element (car).
       */
      class Car {
        constructor() {
          this.reset();
        }

        reset() {
          this.x = Math.random() * canvas.width;
          this.y = canvas.height * (0.8 + Math.random() * 0.1); // Keep cars near the bottom
          this.width = 30;
          this.height = 12;
          this.speed = Math.random() * 1.5 + 0.5;
          this.color = TRAFFIC_DARK;
          this.isClean = false;
        }

        update() {
          this.x += this.speed;
          if (this.x > canvas.width + this.width) {
            this.x = -this.width;
            this.y = canvas.height * (0.8 + Math.random() * 0.1);
          }

          if (this.isClean) {
            // Clean cars move fast and shrink
            this.speed *= 1.05; // Accelerate them away
            this.height *= 0.95;
            this.width *= 0.95;
            if (this.width < 1) this.reset();
          }
        }

        draw() {
          if (this.width < 1) return;
          ctx.fillStyle = this.isClean ? GREEN_PRIMARY : this.color;

          // Simple car shape (body and two wheels)
          ctx.fillRect(this.x, this.y, this.width, this.height);

          // Draw wheels (small circles)
          ctx.fillStyle = this.isClean ? GREEN_LIGHT : "#111";
          ctx.beginPath();
          ctx.arc(
            this.x + this.width * 0.2,
            this.y + this.height + 2,
            3,
            0,
            Math.PI * 2
          );
          ctx.arc(
            this.x + this.width * 0.8,
            this.y + this.height + 2,
            3,
            0,
            Math.PI * 2
          );
          ctx.fill();
        }
      }

      /**
       * Initializes canvas size and populates arrays.
       */
      function init() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        // Initialize particles
        particles = [];
        for (let i = 0; i < MAX_PARTICLES; i++) {
          particles.push(new Particle());
        }

        // Initialize cars
        cars = [];
        for (let i = 0; i < MAX_CARS; i++) {
          cars.push(new Car());
        }

        // Show initial message
        messageElement.textContent = "Nhấn vào nút để dọn sạch ô nhiễm!";
        messageElement.classList.remove("opacity-0");
        messageElement.classList.add("opacity-100");
        cleanButton.classList.add("animate-pulse");
      }

      /**
       * The GreenWave animation drawing and logic.
       */
      function drawGreenWave() {
        if (!isWaving) return;

        // Progress is 0 to 1
        const progress = waveProgress / 100;

        // Wave sweep from left to right (0% to 100% width)
        const waveX = progress * (canvas.width + 100) - 100;
        const waveWidth = canvas.width * 0.5; // Wave peak width

        // Use a radial gradient for the 'clean air' effect
        const gradient = ctx.createRadialGradient(
          waveX,
          canvas.height / 2,
          0, // Inner circle (0 radius)
          waveX,
          canvas.height / 2,
          waveWidth * 1.5 // Outer circle
        );
        gradient.addColorStop(0, `rgba(76, 175, 80, ${0.8 * (1 - progress)})`); // Green Primary (fades out as it sweeps)
        gradient.addColorStop(
          0.5,
          `rgba(76, 175, 80, ${0.4 * (1 - progress)})`
        );
        gradient.addColorStop(1, "rgba(255, 255, 255, 0)");

        ctx.fillStyle = gradient;

        // Draw a large, simple sweeping shape
        ctx.beginPath();
        ctx.ellipse(
          waveX,
          canvas.height / 2,
          waveWidth,
          canvas.height * 0.7,
          0,
          0,
          Math.PI * 2
        );
        ctx.fill();

        // Circuit pattern (simple vertical lines for tech/speed aesthetic)
        if (progress < 0.9) {
          ctx.strokeStyle = GREEN_LIGHT;
          ctx.lineWidth = 1;
          for (let i = -10; i < 10; i++) {
            ctx.beginPath();
            ctx.moveTo(waveX + i * 15, 0);
            ctx.lineTo(waveX + i * 15, canvas.height);
            ctx.stroke();
          }
        }

        // Check for collision (cleaning logic)
        particles.forEach((p) => {
          // Simple collision check: if particle is behind the wave's leading edge
          if (p.x < waveX) {
            p.isClean = true;
          }
        });

        cars.forEach((c) => {
          // Simple collision check for cars
          if (c.x < waveX) {
            c.isClean = true;
          }
        });

        // Update wave progress
        waveProgress += 1.5; // Speed of the wave
        if (waveProgress >= 100) {
          isWaving = false;
          waveProgress = 0;
          cleanButton.disabled = false;
          cleanButton.textContent = "KÍCH HOẠT LÀN SÓNG XANH!";
          cleanButton.classList.add("animate-pulse");

          messageElement.textContent = "Không khí đã sạch! Hãy kích hoạt lại.";
          messageElement.classList.add("opacity-100");
        }
      }

      /**
       * Main animation loop.
       */
      function animate() {
        requestAnimationFrame(animate);

        // 1. Clear the canvas (white background)
        ctx.fillStyle = "#ffffff";
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // 2. Draw pollution and traffic
        particles.forEach((p) => {
          p.update();
          p.draw();
        });
        cars.forEach((c) => {
          c.update();
          c.draw();
        });

        // 3. Draw the GreenWave if active
        drawGreenWave();
      }

      /**
       * Handles the button click to start the wave.
       */
      function handleClean() {
        if (isWaving) return;

        isWaving = true;
        waveProgress = 0;
        cleanButton.disabled = true;
        cleanButton.textContent = "ĐANG DỌN SẠCH...";
        cleanButton.classList.remove("animate-pulse");

        // Reset all elements before cleaning for a dramatic effect
        particles.forEach((p) => p.reset());
        cars.forEach((c) => c.reset());

        messageElement.classList.remove("opacity-100");
        messageElement.classList.add("opacity-0");

        // The 'clean' state will be applied during the drawGreenWave loop.
      }

      // --- Event Listeners ---
      window.addEventListener("resize", init);
      cleanButton.addEventListener("click", handleClean);

      // Start the application
      window.onload = function () {
        init();
        animate();
      };

      // Initial message fade-in control
      setTimeout(() => {
        messageElement.classList.remove("opacity-0");
      }, 500);
    </script>
  </body>
</html>
