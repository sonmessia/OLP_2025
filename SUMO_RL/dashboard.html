<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SUMO-RL Traffic Control Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        h1 {
            color: #333;
            font-size: 2em;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #666;
            font-size: 1.1em;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .card h2 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.3em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .status {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 10px;
            animation: pulse 2s infinite;
        }

        .status-indicator.online {
            background: #10b981;
        }

        .status-indicator.offline {
            background: #ef4444;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .metric {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            background: #f9fafb;
            border-radius: 5px;
            margin-bottom: 8px;
        }

        .metric-label {
            color: #666;
            font-weight: 500;
        }

        .metric-value {
            color: #333;
            font-weight: 700;
            font-size: 1.1em;
        }

        .traffic-light {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin: 20px 0;
        }

        .light {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 3px solid #333;
            transition: all 0.3s;
        }

        .light.red {
            background: #ef4444;
            box-shadow: 0 0 20px #ef4444;
        }

        .light.yellow {
            background: #f59e0b;
            box-shadow: 0 0 20px #f59e0b;
        }

        .light.green {
            background: #10b981;
            box-shadow: 0 0 20px #10b981;
        }

        .light.off {
            background: #4b5563;
        }

        .chart-container {
            height: 200px;
            background: #f9fafb;
            border-radius: 5px;
            padding: 10px;
            margin-top: 10px;
            position: relative;
            overflow: hidden;
        }

        .chart-bar {
            position: absolute;
            bottom: 0;
            width: 20px;
            background: linear-gradient(to top, #667eea, #764ba2);
            border-radius: 3px 3px 0 0;
            transition: height 0.5s ease;
        }

        .log-container {
            background: #1e293b;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 10px;
        }

        .log-entry {
            margin-bottom: 5px;
            padding: 5px;
            border-left: 3px solid #667eea;
            padding-left: 10px;
        }

        .log-entry.info {
            border-left-color: #3b82f6;
        }

        .log-entry.success {
            border-left-color: #10b981;
        }

        .log-entry.warning {
            border-left-color: #f59e0b;
        }

        .log-entry.error {
            border-left-color: #ef4444;
        }

        .timestamp {
            color: #94a3b8;
            margin-right: 10px;
        }

        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            margin: 5px;
            transition: background 0.3s;
        }

        button:hover {
            background: #764ba2;
        }

        button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }

        .controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .phase-display {
            text-align: center;
            font-size: 3em;
            font-weight: bold;
            color: #667eea;
            margin: 20px 0;
        }

        .queue-bars {
            display: flex;
            gap: 20px;
            margin-top: 15px;
        }

        .queue-bar-container {
            flex: 1;
        }

        .queue-bar-label {
            text-align: center;
            margin-bottom: 5px;
            font-weight: 500;
            color: #666;
        }

        .queue-bar {
            height: 150px;
            background: #f3f4f6;
            border-radius: 5px;
            position: relative;
            overflow: hidden;
        }

        .queue-bar-fill {
            position: absolute;
            bottom: 0;
            width: 100%;
            background: linear-gradient(to top, #ef4444, #f59e0b);
            transition: height 0.5s ease;
            border-radius: 5px 5px 0 0;
        }

        .queue-bar-value {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2em;
            font-weight: bold;
            color: #333;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üö¶ SUMO-RL Traffic Control Dashboard</h1>
            <p class="subtitle">Real-time monitoring - Nga4ThuDuc Junction (4066470692)</p>
        </header>

        <div class="grid">
            <!-- System Status -->
            <div class="card">
                <h2>System Status</h2>
                <div class="status">
                    <div class="status-indicator online" id="orion-status"></div>
                    <span>Orion-LD Broker</span>
                </div>
                <div class="status">
                    <div class="status-indicator online" id="iot-status"></div>
                    <span>IoT Agent (Port 4041)</span>
                </div>
                <div class="status">
                    <div class="status-indicator online" id="ai-status"></div>
                    <span>AI Agent (Port 8080)</span>
                </div>
                <div class="status">
                    <div class="status-indicator online" id="sumo-status"></div>
                    <span>SUMO Simulation</span>
                </div>
            </div>

            <!-- Traffic Light Phase -->
            <div class="card">
                <h2>Current Traffic Light Phase</h2>
                <div class="phase-display" id="current-phase">0</div>
                <div class="traffic-light">
                    <div class="light off" id="light-red"></div>
                    <div class="light off" id="light-yellow"></div>
                    <div class="light off" id="light-green"></div>
                </div>
            </div>

            <!-- AI Performance -->
            <div class="card">
                <h2>AI Performance</h2>
                <div class="metric">
                    <span class="metric-label">Total Reward</span>
                    <span class="metric-value" id="total-reward">0</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Avg Reward/Step</span>
                    <span class="metric-value" id="avg-reward">0.00</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Steps</span>
                    <span class="metric-value" id="total-steps">0</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Phase Changes</span>
                    <span class="metric-value" id="phase-changes">0</span>
                </div>
            </div>
        </div>

        <div class="grid">
            <!-- Queue Status -->
            <div class="card">
                <h2>Queue Status</h2>
                <div class="queue-bars">
                    <div class="queue-bar-container">
                        <div class="queue-bar-label">Detector e2_0</div>
                        <div class="queue-bar">
                            <div class="queue-bar-fill" id="queue-0-fill" style="height: 0%"></div>
                            <div class="queue-bar-value" id="queue-0-value">0</div>
                        </div>
                    </div>
                    <div class="queue-bar-container">
                        <div class="queue-bar-label">Detector e2_2</div>
                        <div class="queue-bar">
                            <div class="queue-bar-fill" id="queue-2-fill" style="height: 0%"></div>
                            <div class="queue-bar-value" id="queue-2-value">0</div>
                        </div>
                    </div>
                </div>
                <div class="metric" style="margin-top: 15px;">
                    <span class="metric-label">Total Queue</span>
                    <span class="metric-value" id="total-queue">0</span>
                </div>
            </div>

            <!-- Environment Metrics -->
            <div class="card">
                <h2>Environment Metrics</h2>
                <div class="metric">
                    <span class="metric-label">PM2.5 Emissions</span>
                    <span class="metric-value" id="pm25">0.00 mg</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Vehicles in Simulation</span>
                    <span class="metric-value" id="vehicles">0</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Simulation Time</span>
                    <span class="metric-value" id="sim-time">0.0s</span>
                </div>
                <div class="chart-container" id="pm25-chart"></div>
            </div>

            <!-- Reward History -->
            <div class="card">
                <h2>Reward History</h2>
                <div class="chart-container" id="reward-chart"></div>
            </div>
        </div>

        <!-- Controls -->
        <div class="card">
            <h2>Controls</h2>
            <div class="controls">
                <button onclick="fetchOrionData()">üîÑ Refresh Data</button>
                <button onclick="sendPhaseCommand(0)">üî¥ Force Phase 0</button>
                <button onclick="sendPhaseCommand(1)">üü¢ Force Phase 1</button>
                <button onclick="clearLogs()">üóëÔ∏è Clear Logs</button>
            </div>
        </div>

        <!-- Activity Log -->
        <div class="card">
            <h2>Activity Log</h2>
            <div class="log-container" id="log-container">
                <div class="log-entry info">
                    <span class="timestamp">[00:00:00]</span>
                    <span>Dashboard initialized</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const ORION_HOST = 'http://localhost:1026/ngsi-ld/v1';
        const TLS_ID = '4066470692';
        const UPDATE_INTERVAL = 2000; // 2 seconds
        const DEMO_MODE = true; // Set to false when Orion is available
        
        // State
        let rewardHistory = [];
        let pm25History = [];
        let totalSteps = 0;
        let totalReward = 0;
        let phaseChanges = 0;
        let lastPhase = 0;

        // Initialize
        function init() {
            addLog('Dashboard started', 'success');
            if (DEMO_MODE) {
                addLog('Running in DEMO MODE with simulated data', 'warning');
                addLog('Set DEMO_MODE=false to connect to Orion', 'info');
            } else {
                addLog('Connecting to Orion-LD at ' + ORION_HOST, 'info');
            }
            startAutoRefresh();
            updateCharts();
            fetchOrionData(); // Initial fetch
        }

        // Fetch data from Orion
        async function fetchOrionData() {
            if (DEMO_MODE) {
                // Demo mode with simulated data
                const demoTrafficData = {
                    queues: { value: [Math.floor(Math.random() * 5), Math.floor(Math.random() * 5)] },
                    phase: { value: Math.floor(Math.random() * 2) }
                };
                const demoAirData = {
                    pm25: { value: Math.random() * 100 }
                };
                updateDashboard(demoTrafficData, demoAirData);
                return;
            }

            try {
                // Fetch Traffic Flow data
                const trafficResponse = await fetch(
                    `${ORION_HOST}/entities/urn:ngsi-ld:TrafficFlowObserved:${TLS_ID}`,
                    { 
                        headers: { 'Accept': 'application/json' },
                        mode: 'cors'
                    }
                );
                
                // Fetch Air Quality data
                const airResponse = await fetch(
                    `${ORION_HOST}/entities/urn:ngsi-ld:AirQualityObserved:${TLS_ID}`,
                    { 
                        headers: { 'Accept': 'application/json' },
                        mode: 'cors'
                    }
                );

                if (trafficResponse.ok && airResponse.ok) {
                    const trafficData = await trafficResponse.json();
                    const airData = await airResponse.json();
                    
                    updateDashboard(trafficData, airData);
                    addLog('Data refreshed from Orion', 'success');
                    updateSystemStatus(true);
                } else {
                    addLog(`Failed to fetch data: ${trafficResponse.status}, ${airResponse.status}`, 'error');
                    updateSystemStatus(false);
                }
            } catch (error) {
                addLog(`Connection error: ${error.message}`, 'error');
                addLog('Enable DEMO_MODE or check Orion connection', 'warning');
                updateSystemStatus(false);
            }
        }

        // Update dashboard with new data
        function updateDashboard(trafficData, airData) {
            // Extract data
            const queues = trafficData.queues?.value || [0, 0];
            const phase = trafficData.phase?.value || 0;
            const pm25 = airData.pm25?.value || 0;

            // Update queues
            updateQueue(0, queues[0]);
            updateQueue(1, queues[1]);
            document.getElementById('total-queue').textContent = queues[0] + queues[1];

            // Update phase
            updatePhase(phase);

            // Update PM2.5
            document.getElementById('pm25').textContent = pm25.toFixed(2) + ' mg';

            // Update metrics
            totalSteps++;
            const reward = calculateReward(queues, pm25);
            totalReward += reward;
            rewardHistory.push(reward);
            pm25History.push(pm25);

            if (rewardHistory.length > 50) {
                rewardHistory.shift();
                pm25History.shift();
            }

            document.getElementById('total-reward').textContent = totalReward.toFixed(0);
            document.getElementById('avg-reward').textContent = (totalReward / totalSteps).toFixed(2);
            document.getElementById('total-steps').textContent = totalSteps;

            // Update phase changes
            if (phase !== lastPhase) {
                phaseChanges++;
                document.getElementById('phase-changes').textContent = phaseChanges;
                addLog(`Phase changed: ${lastPhase} ‚Üí ${phase}`, 'info');
                lastPhase = phase;
            }

            // Update charts
            updateCharts();
            updateSystemStatus(true);
        }

        // Calculate reward
        function calculateReward(queues, pm25) {
            const queueLength = queues[0] + queues[1];
            return 0.6 * (-queueLength) + 0.4 * (-pm25 / 1000);
        }

        // Update queue visualization
        function updateQueue(index, value) {
            const maxQueue = 10;
            const percentage = Math.min((value / maxQueue) * 100, 100);
            
            document.getElementById(`queue-${index === 0 ? '0' : '2'}-fill`).style.height = percentage + '%';
            document.getElementById(`queue-${index === 0 ? '0' : '2'}-value`).textContent = value;
        }

        // Update traffic light phase
        function updatePhase(phase) {
            document.getElementById('current-phase').textContent = phase;
            
            // Reset all lights
            document.getElementById('light-red').className = 'light off';
            document.getElementById('light-yellow').className = 'light off';
            document.getElementById('light-green').className = 'light off';
            
            // Light up based on phase
            if (phase === 0) {
                document.getElementById('light-green').className = 'light green';
            } else {
                document.getElementById('light-red').className = 'light red';
            }
        }

        // Update charts
        function updateCharts() {
            updateRewardChart();
            updatePM25Chart();
        }

        function updateRewardChart() {
            const container = document.getElementById('reward-chart');
            container.innerHTML = '';
            
            const maxValue = Math.max(...rewardHistory.map(Math.abs), 1);
            rewardHistory.forEach((reward, index) => {
                const bar = document.createElement('div');
                bar.className = 'chart-bar';
                bar.style.left = `${(index / 50) * 100}%`;
                bar.style.height = `${(Math.abs(reward) / maxValue) * 100}%`;
                container.appendChild(bar);
            });
        }

        function updatePM25Chart() {
            const container = document.getElementById('pm25-chart');
            container.innerHTML = '';
            
            const maxValue = Math.max(...pm25History, 1);
            pm25History.forEach((pm25, index) => {
                const bar = document.createElement('div');
                bar.className = 'chart-bar';
                bar.style.left = `${(index / 50) * 100}%`;
                bar.style.height = `${(pm25 / maxValue) * 100}%`;
                container.appendChild(bar);
            });
        }

        // Send phase change command
        async function sendPhaseCommand(phase) {
            if (DEMO_MODE) {
                addLog(`[DEMO] Phase change to ${phase} (not sent)`, 'warning');
                updatePhase(phase);
                return;
            }

            try {
                const response = await fetch(
                    `${ORION_HOST}/entities/urn:ngsi-ld:TrafficLight:${TLS_ID}/attrs`,
                    {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json' },
                        mode: 'cors',
                        body: JSON.stringify({
                            forcePhase: {
                                type: 'Property',
                                value: phase
                            }
                        })
                    }
                );

                if (response.ok || response.status === 204) {
                    addLog(`Manual phase change to ${phase} sent`, 'success');
                } else {
                    addLog(`Failed to send phase command: ${response.status}`, 'error');
                }
            } catch (error) {
                addLog(`Error sending command: ${error.message}`, 'error');
            }
        }

        // Update system status indicators
        function updateSystemStatus(isOnline) {
            const orionIndicator = document.getElementById('orion-status');
            orionIndicator.className = `status-indicator ${isOnline || DEMO_MODE ? 'online' : 'offline'}`;
            
            // Update other indicators based on demo mode
            if (DEMO_MODE) {
                document.getElementById('iot-status').className = 'status-indicator online';
                document.getElementById('ai-status').className = 'status-indicator online';
                document.getElementById('sumo-status').className = 'status-indicator online';
            }
        }

        // Add log entry
        function addLog(message, type = 'info') {
            const container = document.getElementById('log-container');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            
            const now = new Date();
            const timestamp = now.toTimeString().split(' ')[0];
            
            entry.innerHTML = `<span class="timestamp">[${timestamp}]</span><span>${message}</span>`;
            container.appendChild(entry);
            container.scrollTop = container.scrollHeight;

            // Keep only last 50 logs
            while (container.children.length > 50) {
                container.removeChild(container.firstChild);
            }
        }

        // Clear logs
        function clearLogs() {
            document.getElementById('log-container').innerHTML = '';
            addLog('Logs cleared', 'info');
        }

        // Auto refresh
        function startAutoRefresh() {
            setInterval(fetchOrionData, UPDATE_INTERVAL);
        }

        // Initialize on load
        window.onload = init;
    </script>
</body>
</html>
