<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GreenWave Traffic Control Center</title>
    <link rel="stylesheet" href="index.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
  </head>
  <body>
    <div class="container">
      <header>
        <div>
          <h1>üö¶ GreenWave Control Center</h1>
          <p class="subtitle">
            Giao l·ªô: Ng√£ 4 Th·ªß ƒê·ª©c (ID: 4066470692) - Hybrid View
          </p>
        </div>
        <div class="status-badge">
          <div class="status-dot offline" id="sys-status"></div>
          <span id="sys-status-text">Disconnected</span>
        </div>
      </header>

      <div class="grid">
        <div class="col-span-8">
          <div class="card">
            <h2>
              <span><i class="fas fa-road"></i> M√¥ ph·ªèng Giao th√¥ng</span>
              <span style="font-size: 0.7em; color: #94a3b8" id="phase-badge"
                >Phase: --</span
              >
            </h2>

            <div class="road-container">
              <div class="road horizontal">
                <div class="stop-line-h"></div>
                <div class="lane-horizontal-container" id="lane-0-cars"></div>
                <div class="traffic-light-mini h-loc" id="tl-0">
                  <div class="bulb red"></div>
                  <div class="bulb yellow"></div>
                  <div class="bulb green"></div>
                </div>
                <div
                  style="
                    position: absolute;
                    left: 10px;
                    top: 10px;
                    color: #64748b;
                    font-size: 0.8em;
                  "
                >
                  L√†n e2_0 (ƒê√¥ng-T√¢y)
                </div>
              </div>

              <div class="road vertical">
                <div class="stop-line-v"></div>
                <div class="lane-vertical-container" id="lane-2-cars"></div>
                <div class="traffic-light-mini v-loc" id="tl-2">
                  <div class="bulb red"></div>
                  <div class="bulb yellow"></div>
                  <div class="bulb green"></div>
                </div>
                <div
                  style="
                    position: absolute;
                    bottom: 10px;
                    right: 10px;
                    color: #64748b;
                    font-size: 0.8em;
                    writing-mode: vertical-rl;
                  "
                >
                  L√†n e2_2 (B·∫Øc-Nam)
                </div>
              </div>
            </div>
          </div>

          <div class="card">
            <h2>ƒêi·ªÅu khi·ªÉn</h2>
            <div style="display: flex; gap: 10px">
              <button onclick="sendPhaseCommand(0)">
                <i class="fas fa-arrow-right"></i> ∆Øu ti√™n ƒê√¥ng-T√¢y
              </button>
              <button onclick="sendPhaseCommand(1)">
                <i class="fas fa-arrow-up"></i> ∆Øu ti√™n B·∫Øc-Nam
              </button>
              <button onclick="fetchOrionData()" style="background: #475569">
                <i class="fas fa-sync"></i> Refresh
              </button>
            </div>
          </div>
        </div>

        <div class="col-span-4">
          <div class="card">
            <h2><i class="fas fa-chart-line"></i> Reward History</h2>
            <div class="chart-container" id="reward-chart"></div>
            <div
              class="metric-row"
              style="margin-top: 10px; background: none; padding: 0"
            >
              <span>Reward hi·ªán t·∫°i:</span>
              <span class="metric-value" id="ai-reward">0</span>
            </div>
          </div>

          <div class="card">
            <h2><i class="fas fa-smog"></i> PM2.5 History</h2>
            <div class="chart-container" id="pm25-chart"></div>
            <div
              class="metric-row"
              style="margin-top: 10px; background: none; padding: 0"
            >
              <span>N·ªìng ƒë·ªô hi·ªán t·∫°i:</span>
              <span class="metric-value" id="pm25-text">0.00</span>
            </div>
          </div>

          <div class="card">
            <h2><i class="fas fa-table"></i> D·ªØ li·ªáu chi ti·∫øt (Live)</h2>
            <div class="table-wrapper">
              <table class="data-table" id="data-log-table">
                <thead>
                  <tr>
                    <th>Time</th>
                    <th>Q_0</th>
                    <th>Q_2</th>
                    <th>Phase</th>
                    <th>PM2.5</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>

          <div class="card">
            <h2>
              Nh·∫≠t k√Ω h·ªá th·ªëng
              <button
                onclick="clearLogs()"
                style="font-size: 0.6em; padding: 2px 6px; float: right"
              >
                X√≥a
              </button>
            </h2>
            <div class="log-container" id="log-container"></div>
          </div>
        </div>
      </div>
    </div>

    <script>
      const ORION_HOST = "http://localhost:8080/proxy/orion";
      const TLS_ID = "4066470692";
      const UPDATE_INTERVAL = 2000;

      let rewardHistory = [];
      let pm25History = [];
      let lastPhase = -1;

      function init() {
        addLog("H·ªá th·ªëng kh·ªüi ƒë·ªông...");
        startAutoRefresh();
        fetchOrionData();
      }

      async function fetchOrionData() {
        try {
          const [trafficRes, airRes] = await Promise.all([
            fetch(
              `${ORION_HOST}/entities/urn:ngsi-ld:TrafficFlowObserved:${TLS_ID}`,
              { headers: { Accept: "application/json" } }
            ),
            fetch(
              `${ORION_HOST}/entities/urn:ngsi-ld:AirQualityObserved:${TLS_ID}`,
              { headers: { Accept: "application/json" } }
            ),
          ]);

          if (trafficRes.ok && airRes.ok) {
            const trafficData = await trafficRes.json();
            const airData = await airRes.json();

            updateUI(trafficData, airData);
            updateStatus(true);
          } else {
            throw new Error("API Error");
          }
        } catch (error) {
          updateStatus(false);
        }
      }

      function updateUI(trafficData, airData) {
        const queues = trafficData.queues?.value || [0, 0];
        const phase = trafficData.phase?.value || 0;
        const pm25 = airData.pm25?.value || 0;

        // --- 1. C·∫¨P NH·∫¨T TEXT & CHARTS ---
        document.getElementById("pm25-text").textContent = pm25.toFixed(2);

        const reward = -(queues[0] + queues[1]) * 0.6 - (pm25 / 100) * 0.4;
        document.getElementById("ai-reward").textContent = reward.toFixed(2);

        rewardHistory.push(reward);
        pm25History.push(pm25);

        if (rewardHistory.length > 50) rewardHistory.shift();
        if (pm25History.length > 50) pm25History.shift();

        drawChart("reward-chart", rewardHistory, true);
        drawChart("pm25-chart", pm25History, false);

        // --- 2. C·∫¨P NH·∫¨T VISUAL ROAD ---
        updateVisualRoad(queues, phase);

        // --- 3. C·∫¨P NH·∫¨T B·∫¢NG LOG D·ªÆ LI·ªÜU (M·ªöI) ---
        updateDataLogTable(queues, phase, pm25);

        // --- 4. SYSTEM LOG ---
        if (phase !== lastPhase) {
          addLog(`Chuy·ªÉn Phase: ${lastPhase} -> ${phase}`);
          lastPhase = phase;
        }
      }

      // --- H√ÄM M·ªöI: C·∫¨P NH·∫¨T B·∫¢NG D·ªÆ LI·ªÜU ---
      function updateDataLogTable(queues, phase, pm25) {
        const tbody = document.querySelector("#data-log-table tbody");
        const row = document.createElement("tr");

        // L·∫•y gi·ªù ph√∫t gi√¢y hi·ªán t·∫°i
        const time = new Date().toLocaleTimeString("vi-VN", { hour12: false });

        row.innerHTML = `
              <td>${time}</td>
              <td>${queues[0]}</td>
              <td>${queues[1]}</td>
              <td>
                  <span style="color: ${phase === 0 ? "#10b981" : "#ef4444"}">
                      ${phase}
                  </span>
              </td>
              <td>${pm25.toFixed(1)}</td>
          `;

        // Th√™m v√†o ƒë·∫ßu b·∫£ng
        tbody.prepend(row);

        // Gi·ªõi h·∫°n gi·ªØ l·∫°i 20 d√≤ng m·ªõi nh·∫•t ƒë·ªÉ kh√¥ng lag
        if (tbody.children.length > 20) {
          tbody.lastChild.remove();
        }
      }

      // --- VISUAL ROAD ---
      function updateVisualRoad(queues, phase) {
        document.getElementById("phase-badge").textContent = `Phase: ${phase}`;
        const setLight = (id, color) => {
          const el = document.getElementById(id);
          el.querySelector(".red").className = `bulb red ${
            color === "red" ? "active" : ""
          }`;
          el.querySelector(".yellow").className = `bulb yellow ${
            color === "yellow" ? "active" : ""
          }`;
          el.querySelector(".green").className = `bulb green ${
            color === "green" ? "active" : ""
          }`;
        };
        let hColor = "red",
          vColor = "red";
        if (phase === 0) {
          hColor = "green";
          vColor = "red";
        } else if (phase === 1) {
          hColor = "red";
          vColor = "green";
        } else {
          hColor = "yellow";
          vColor = "yellow";
        }

        setLight("tl-0", hColor);
        setLight("tl-2", vColor);

        renderLane("lane-0-cars", queues[0], "h-car", hColor === "green");
        renderLane("lane-2-cars", queues[1], "v-car", vColor === "green");
      }

      function renderLane(containerId, count, carClass, isMoving) {
        const container = document.getElementById(containerId);
        container.innerHTML = "";
        const displayCount = Math.min(count, 8);
        for (let i = 0; i < displayCount; i++) {
          const car = document.createElement("i");
          car.className = `fas fa-car car-icon ${carClass}`;
          if (isMoving) car.classList.add("moving");
          container.appendChild(car);
        }
        if (count > 8) {
          const plus = document.createElement("span");
          plus.textContent = "+";
          plus.style.color = "#94a3b8";
          container.appendChild(plus);
        }
      }

      // --- CHARTS ---
      function drawChart(containerId, data, allowNegative) {
        const container = document.getElementById(containerId);
        container.innerHTML = "";
        let minVal = Math.min(...data);
        if (!allowNegative) minVal = 0;
        const absMax = Math.max(...data.map(Math.abs), 1);

        data.forEach((val) => {
          const bar = document.createElement("div");
          bar.className = "chart-bar";
          const height = (Math.abs(val) / absMax) * 90;
          bar.style.height = `${height}%`;
          if (allowNegative && val < 0) {
            bar.style.background = "linear-gradient(to top, #ef4444, #f97316)";
          } else {
            bar.style.background = "linear-gradient(to top, #667eea, #764ba2)";
          }
          container.appendChild(bar);
        });
      }

      // --- UTILS ---
      async function sendPhaseCommand(phase) {
        try {
          await fetch(
            `${ORION_HOST}/entities/urn:ngsi-ld:TrafficLight:${TLS_ID}/attrs`,
            {
              method: "PATCH",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                forcePhase: { type: "Property", value: phase },
              }),
            }
          );
          addLog(`L·ªánh g·ª≠i: Phase ${phase}`);
          setTimeout(fetchOrionData, 200);
        } catch (e) {
          addLog("L·ªói g·ª≠i l·ªánh");
        }
      }

      function updateStatus(isOnline) {
        const el = document.getElementById("sys-status");
        const txt = document.getElementById("sys-status-text");
        if (isOnline) {
          el.className = "status-dot online";
          txt.textContent = "Connected";
          txt.style.color = "#10b981";
        } else {
          el.className = "status-dot offline";
          txt.textContent = "Offline";
          txt.style.color = "#ef4444";
        }
      }

      function addLog(msg) {
        const box = document.getElementById("log-container");
        const entry = document.createElement("div");
        entry.className = "log-entry";
        entry.innerHTML = `<span>[${new Date().toLocaleTimeString()}]</span> ${msg}`;
        box.prepend(entry);
      }

      function clearLogs() {
        document.getElementById("log-container").innerHTML = "";
      }
      function startAutoRefresh() {
        setInterval(fetchOrionData, UPDATE_INTERVAL);
      }

      window.onload = init;
    </script>
  </body>
</html>
